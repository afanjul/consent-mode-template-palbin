___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "categories": ["AFFILIATE_MARKETING", "ADVERTISING"],
  "securityGroups": [],
  "displayName": "Modo de consentimiento o Consent Mode - Palbin.com",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Plantilla personalizada",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Usa esta plantilla para crear 2 tags diferentes. Uno para establecer el consent mode por Defecto (Default), y otro para actualizar el consent mode (Update).",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "commandGroup",
    "displayName": "Elige el tipo de etiqueta que quieres crear",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "command",
        "displayName": "",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "default",
            "displayValue": "Etiqueta para esta establecer el consent mode por Defecto (Default)"
          },
          {
            "value": "update",
            "displayValue": "Etiqueta para esta Actualizar el consent mode (Update)"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "default",
        "alwaysInSummary": true,
        "subParams": [],
        "help": ""
      }
    ],
    "help": "Elige qué comando del Modo de consentimiento debe activar esta instancia de la plantilla"
  },
  {
    "type": "GROUP",
    "name": "defaultGroup",
    "displayName": "Parámetros para el modo por Defecto (Default)",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "defaultSettings",
        "displayName": "",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "region",
              "displayName": "Region (dejar en blanco para aplicar a todas las regiones)",
              "simpleValueType": true
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "SELECT",
              "name": "adStorage",
              "displayName": "ad_storage",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "",
                  "displayValue": "(not set)"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "analyticsStorage",
              "displayName": "analytics_storage",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "",
                  "displayValue": "(not set)"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "functionalityStorage",
              "displayName": "functionality_storage",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "",
                  "displayValue": "(not set)"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "personalizationStorage",
              "displayName": "personalization_storage",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "",
                  "displayValue": "(not set)"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "securityStorage",
              "displayName": "security_storage",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "",
                  "displayValue": "(not set)"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "adUserData",
              "displayName": "ad_user_data",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "",
                  "displayValue": "(not set)"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "adPersonalization",
              "displayName": "ad_personalization",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "",
                  "displayValue": "(not set)"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied"
            },
            "isUnique": false
          }
        ],
        "valueValidators": [
          {
            "type": "TABLE_ROW_COUNT",
            "args": [
              1
            ]
          }
        ]
      },
      {
        "type": "LABEL",
        "name": "defaultLabel",
        "displayName": "Esta etiqueta debe activarse mediante el activador de \"Inicialización de consentimiento\" para garantizar que la configuración de consentimiento por defecto esté establecida antes de que se active cualquier etiqueta. IMPORTANTE: Asegúrese de crear otra etiqueta (usando esta misma plantilla) que utilice el comando \"Actualizar\". Si no se configuran correctamente ambas etiquetas, el comportamiento será erróneo."
      },
      {
        "type": "GROUP",
        "name": "settingsGroup",
        "displayName": "Configuración adicional",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "adsDataRedaction",
            "checkboxText": "Redact Ads Data",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "waitForUpdate",
            "displayName": "Wait For Update",
            "simpleValueType": true,
            "valueUnit": "ms",
            "help": "Time to wait for update command before firing consent-aware tags",
            "defaultValue": 500
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "command",
        "paramValue": "default",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "updateGroup",
    "displayName": "Parámetros para el modo de Actualizar (Update)",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "adStorageUpdate",
        "displayName": "ad_storage",
        "simpleValueType": true,
        "canBeEmptyString": true,
        "defaultValue": "{{palbin.consentmode.modes.ad_storage}}"
      },
      {
        "type": "TEXT",
        "name": "analyticsStorageUpdate",
        "displayName": "analytics_storage",
        "simpleValueType": true,
        "canBeEmptyString": true,
        "defaultValue": "{{palbin.consentmode.modes.analytics_storage}}"
      },
      {
        "type": "TEXT",
        "name": "functionalityStorageUpdate",
        "displayName": "functionality_storage",
        "simpleValueType": true,
        "canBeEmptyString": true,
        "defaultValue": "{{palbin.consentmode.modes.functionality_storage}}"
      },
      {
        "type": "TEXT",
        "name": "personalizationStorageUpdate",
        "displayName": "personalization_storage",
        "simpleValueType": true,
        "canBeEmptyString": true,
        "defaultValue": "{{palbin.consentmode.modes.personalization_storage}}"
      },
      {
        "type": "TEXT",
        "name": "securityStorageUpdate",
        "displayName": "security_storage",
        "simpleValueType": true,
        "canBeEmptyString": true,
        "defaultValue": "{{palbin.consentmode.modes.security_storage}}"
      },
      {
        "type": "TEXT",
        "name": "adUserDataUpdate",
        "displayName": "ad_user_data",
        "simpleValueType": true,
        "canBeEmptyString": true,
        "defaultValue": "{{palbin.consentmode.modes.ad_user_data}}"
      },
      {
        "type": "TEXT",
        "name": "adPersonalizationUpdate",
        "displayName": "ad_personalization",
        "simpleValueType": true,
        "canBeEmptyString": true,
        "defaultValue": "{{palbin.consentmode.modes.ad_personalization}}"
      },
      {
        "type": "LABEL",
        "name": "updateLabel",
        "displayName": "Esta etiqueta debe activarse mediante el disparador \"palbin.trigger.consentmode.update\" que se lanzará automáticamente cuando se actualice el consentimiento. \nSi no quieres alterar el comportamiento, deja los valores por defecto que se proporcionan para cada uno de los consentimientos. \nIMPORTANTE: asegúrese de haber creado una etiqueta separada para establecer el modo por Defecto \"Default\". Si no se configuran correctamente ambas etiquetas, se producirá un comportamiento de etiqueta no deseado."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "command",
        "paramValue": "update",
        "type": "EQUALS"
      }
    ],
    "help": "Esta etiqueta debe activarse en un disparador que se ejecute cuando se actualice el consentimiento. Seleccione una variable en cada uno de los menús desplegables anteriores que esté configurada como \"granted\" cuando se otorga el consentimiento y \"denied\" cuando no se otorga el consentimiento para el tipo de consentimiento de la fila. IMPORTANTE: asegúrese de haber creado una etiqueta separada que utilice el comando \"Default\". Si no se configuran correctamente ambas etiquetas, se producirá un comportamiento de etiqueta no deseado."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const gtagSet = require('gtagSet');
const splitInput = (input) => {
  return input.split(',')
    .map(entry => entry.trim())
    .filter(entry => entry.length !== 0);
};
const parseDefaultCommandData = (settings) => {
  const regions = splitInput(settings.region);
  const commandData = {};
  
  if (regions.length > 0) {
    commandData.region = regions;
  }
  if(settings.adStorage === 'granted' || settings.adStorage === 'denied') {
    commandData.ad_storage = settings.adStorage;
  }
  if(settings.analyticsStorage === 'granted' || settings.analyticsStorage === 'denied') {
    commandData.analytics_storage = settings.analyticsStorage;
  }
  if(settings.functionalityStorage === 'granted' || settings.functionalityStorage === 'denied') {
    commandData.functionality_storage = settings.functionalityStorage;
  }
  if(settings.personalizationStorage === 'granted' || settings.personalizationStorage === 'denied') {
    commandData.personalization_storage = settings.personalizationStorage;
  }
  if(settings.securityStorage === 'granted' || settings.securityStorage === 'denied') {
    commandData.security_storage = settings.securityStorage;
  }
  if(settings.adUserData === 'granted' || settings.adUserData === 'denied') {
    commandData.ad_user_data = settings.adUserData;
  }
  if(settings.adPersonalization === 'granted' || settings.adPersonalization === 'denied') {
    commandData.ad_personalization = settings.adPersonalization;
  }
  return commandData;
};
const processData = () => {
  if (data.command === 'default') {
    data.defaultSettings.forEach(settings => {
      const commandData = parseDefaultCommandData(settings);
      if(data.waitForUpdate > 0) {
        commandData.wait_for_update = data.waitForUpdate;
      }
      setDefaultConsentState(commandData);
    });
    gtagSet('ads_data_redaction', data.adsDataRedaction);
  }
  if (data.command === 'update') {
    const commandData = {};
    if(data.adStorageUpdate === 'granted' || data.adStorageUpdate === 'denied') {
      commandData.ad_storage = data.adStorageUpdate;
    }
    if(data.analyticsStorageUpdate === 'granted' || data.analyticsStorageUpdate === 'denied') {
      commandData.analytics_storage = data.analyticsStorageUpdate;
    }
    if(data.functionalityStorageUpdate === 'granted' || data.functionalityStorageUpdate === 'denied') {
      commandData.functionality_storage = data.functionalityStorageUpdate;
    }
    if(data.personalizationStorageUpdate === 'granted' || data.personalizationStorageUpdate === 'denied') {
      commandData.personalization_storage = data.personalizationStorageUpdate;
    }
    if(data.securityStorageUpdate === 'granted' || data.securityStorageUpdate === 'denied') {
      commandData.security_storage = data.securityStorageUpdate;
    }
    if(data.adUserDataUpdate === 'granted' || data.adUserDataUpdate === 'denied') {
      commandData.ad_user_data = data.adUserDataUpdate;
    }
    if(data.adPersonalizationUpdate === 'granted' || data.adPersonalizationUpdate === 'denied') {
      commandData.ad_personalization = data.adPersonalizationUpdate;
    }
    updateConsentState(commandData);
  }
};
processData();
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ads_data_redaction"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Defaults set correctly - Global Granted
  code: "const mockData = {\n  command: 'default',\n  defaultSettings: [\n    {\n\
    \      'region':'',\n      'adStorage':'granted',\n      'analyticsStorage':'granted',\n\
    \      'functionalityStorage':'granted',\n      'personalizationStorage':'granted',\n\
    \      'securityStorage':'granted',\n      'adUserData':'granted',\n      'adPersonalization':'granted',\n\
    \    }\n  ],  \n};\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('setDefaultConsentState').wasCalledWith({\n  ad_storage: 'granted',\n\
    \  analytics_storage: 'granted',\n  functionality_storage: 'granted',\n  personalization_storage:\
    \ 'granted',\n  security_storage: 'granted',\n  ad_user_data: 'granted',\n  ad_personalization:\
    \ 'granted',\n});"
- name: Defaults set correctly - Global Denied
  code: "const mockData = {\n  command: 'default',\n  defaultSettings: [\n    {\n\
    \      'region':'',\n      'adStorage':'denied',\n      'analyticsStorage':'denied',\n\
    \      'functionalityStorage':'denied',\n      'personalizationStorage':'denied',\n\
    \      'securityStorage':'denied',\n      'adUserData':'denied',\n      'adPersonalization':'denied',\n\
    \    }\n  ], \n};\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('setDefaultConsentState').wasCalledWith({\n  ad_storage: 'denied',\n\
    \  analytics_storage: 'denied',\n  functionality_storage: 'denied',\n  personalization_storage:\
    \ 'denied',\n  security_storage: 'denied',\n  ad_user_data: 'denied',\n  ad_personalization:\
    \ 'denied',\n});"
- name: Analytics Storage Default Not Set - Bad Value Provided
  code: "const mockData = {\n  command: 'default',\n  defaultSettings: [\n    {\n\
    \      'region':'',\n      'adStorage':'denied',\n      'analyticsStorage':'badValue',\n\
    \    }\n  ],  \n};\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('setDefaultConsentState').wasCalledWith({\n  ad_storage: 'denied',\n\
    });"
- name: Updates set correctly - Denied to Granted
  code: |-
    const setDefaultConsentState = require('setDefaultConsentState');
    const mockData = {
      command: 'update',
      adStorageUpdate: 'granted',
      analyticsStorageUpdate: 'granted',
      adUserDataUpdate: 'granted',
      adPersonalizationUpdate: 'granted',
    };
    setDefaultConsentState({
      'ad_storage': 'denied',
      'analytics_storage': 'denied',
      'ad_user_data': 'denied',
      'ad_personalization': 'denied',
    });
    // Call runCode to run the template's code.
    runCode(mockData);
    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('updateConsentState').wasCalledWith({
      ad_storage: 'granted',
      analytics_storage: 'granted',
      ad_user_data: 'granted',
      ad_personalization: 'granted',
    });
- name: Updates set correctly - Granted to Denied
  code: |-
    const setDefaultConsentState = require('setDefaultConsentState');
    const mockData = {
      command: 'update',
      adStorageUpdate: 'denied',
      analyticsStorageUpdate: 'denied',
      adUserDataUpdate: 'denied',
      adPersonalizationUpdate: 'denied',
    };
    setDefaultConsentState({
      'ad_storage': 'granted',
      'analytics_storage': 'granted',
      'ad_user_data': 'granted',
      'ad_personalization': 'granted',
    });
    // Call runCode to run the template's code.
    runCode(mockData);
    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('updateConsentState').wasCalledWith({
      ad_storage: 'denied',
      analytics_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied',
    });
- name: Wait for update set correctly
  code: |-
    const mockData = {
      command: 'default',
      defaultSettings: [
        {
          'region':'',
          'adStorage':'granted',
          'analyticsStorage':'granted',
          'adUserData': 'granted',
          'adPersonalization': 'granted',
        }
      ],
      'waitForUpdate': 500,
    };
    // Call runCode to run the template's code.
    runCode(mockData);
    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('setDefaultConsentState').wasCalledWith({
      ad_storage: 'granted',
      analytics_storage: 'granted',
      ad_user_data: 'granted',
      ad_personalization: 'granted',
      wait_for_update: 500,
    });
- name: Test ads_data_redaction
  code: "const mockData = {\n  command: 'default',\n  defaultSettings: [\n    {\n\
    \      'region':'',\n      'adStorage':'granted',\n      'analyticsStorage':'granted',\n\
    \      'adUserData':'granted',\n      'adPersonalization':'granted',\n    }\n\
    \  ], \n  'waitForUpdate': 500,\n  'adsDataRedaction': true,\n};\n\n// Call runCode\
    \ to run the template's code.\nrunCode(mockData);\n\n// Verify that the tag finished\
    \ successfully.\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('gtagSet').wasCalledWith('ads_data_redaction',true);"
- name: ad_user_data Default not set - Bad Value
  code: "const mockData = {\n  command: 'default',\n  defaultSettings: [\n    {\n\
    \      'region':'',\n      'adStorage':'denied',\n      'analyticsStorage':'denied',\n\
    \      'adUserData':'dneied',\n      'adPersonalization':'denied',\n    }\n  ],\
    \  \n};\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\n\
    // Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('setDefaultConsentState').wasCalledWith({\n  ad_storage: 'denied',\n\
    \  analytics_storage: 'denied',\n  ad_personalization: 'denied',\n});"
- name: ad_personalization Default not set - Bad Value
  code: "const mockData = {\n  command: 'default',\n  defaultSettings: [\n    {\n\
    \      'region':'',\n      'adStorage':'denied',\n      'analyticsStorage':'denied',\n\
    \      'adUserData':'denied',\n      'adPersonalization':'dneied',\n    }\n  ],\
    \  \n};\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\n\
    // Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('setDefaultConsentState').wasCalledWith({\n  ad_storage: 'denied',\n\
    \  analytics_storage: 'denied',\n  ad_user_data: 'denied',\n});"


___NOTES___

Creado el 4/04/2024


